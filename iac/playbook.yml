# iac/playbook.yml
- hosts: all

  become: yes

  gather_facts: false

  tasks:
    - name: Ensure app directory exists and is owned by vagrant
      file:
        path: /vagrant_data/jokes_api/src
        state: directory
        owner: vagrant
        group: vagrant
        mode: '0755'
      become: false

    - name: Update apt cache
      apt:
        update_cache: yes

    # Installing Python, PIP and MySQL
    - name: Install Python 3, pip, and MySQL Server
      apt:
        name: [python3, python3-pip, mysql-server]
        state: present
      become: true

    # MySQL database setup
    - name: Configure MySQL
      shell: |
        # Wait until MySQL is available for connections
        timeout 60 bash -c 'while ! mysqladmin ping -h localhost --silent
        do echo "MySQL not ready yet. Waiting..."
        sleep 2
        done'
          
        sudo service mysql restart
        
        # Creating the database
        sudo mysql -e "CREATE DATABASE IF NOT EXISTS jokedb;"
        
        # Creating user 
        sudo mysql -e "CREATE USER 'joke_user'@'localhost' IDENTIFIED BY 'joke_secret_pass';"
        sudo mysql -e "GRANT ALL PRIVILEGES ON jokedb.* TO 'joke_user'@'localhost';"
        sudo mysql -e "FLUSH PRIVILEGES;"

    # Installing the application dependencies
    - name: Install Python app dependencies
      pip:
        requirements: /vagrant_data/requirements.txt
      become: true

    # Running the application
    - name: Run the application and capture logs
      shell: | 
        export PATH=$PATH:$HOME/.local/bin
        export PYTHONPATH=$PYTHONPATH:/vagrant_data
        source /vagrant_data/.env
        
        # Running uvicorn as a background process
        cd /vagrant_data
        nohup python3 -m uvicorn jokes_api.src.main:app --host 0.0.0.0 --port 8000 > /tmp/app_start.log 2>&1 &
      become: false
      register: app_start
      environment:
        DB_HOST: "localhost"
        DB_NAME: "jokedb"
        DB_USER: "joke_user"
        DB_PASS: "joke_secret_pass"

    - name: Wait for startup (10 seconds)
      pause:
        seconds: 10

    - name: CHECK APP STATUS
      uri:
        url: http://127.0.0.1:8000/health
        status_code: 200
        validate_certs: false
      register: health_check
      ignore_errors: true

    - name: Debug and Fail if crash detected
      fail:
        msg: |
          Application failed to start within 5 seconds (TIMEOUT). This is a fatal crash.
          --- VM LOG (Showing Python Traceback) ---
          "{{ lookup('file', '/tmp/app_start.log') }}"
      when: health_check is failed

    - name: Final Wait for the app to start (max 60s)
      wait_for:
        port: 8000
        delay: 5
        timeout: 60
      when: health_check is success

    - name: Collect 3 Jokes & Print Final Proof
      shell: |
        curl -X POST http://localhost:8000/jokes/collect?count=3 > /tmp/collected_jokes.json
        curl http://localhost:8000/jokes > /tmp/final_jokes_list.json
      args:
        chdir: /vagrant_data
      when: health_check is success

    - name: Fetch Final Proof of Work file
      ansible.builtin.fetch:
        src: /tmp/final_jokes_list.json
        dest: /tmp/
        flat: yes
      when: health_check is success

    - name: Print Final Proof of Work
      debug:
        msg: |
          =======================================================
          The Ansible provisioner successfully installed all software,
          configured MySQL, deployed the application, ran it, and
          verified database writes.
          
          "{{ lookup('file', '/tmp/final_jokes_list.json') }}"
          =======================================================
      when: health_check is success